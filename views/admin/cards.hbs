{{!-- Admin Cards Management with TAP ME IN! Branding --}}
<div class="container-fluid">
    <div class="row">
        <!-- Admin Sidebar -->
        <nav class="col-md-3 col-lg-2 d-md-block" style="background: var(--brand-navy-darker); min-height: calc(100vh - 152px); position: sticky; top: 76px;">
            <div class="position-sticky pt-3">
                <div class="d-flex align-items-center mb-4 px-3">
                    <i class="bi bi-shield-check fs-2 me-2" style="color: var(--brand-yellow);"></i>
                    <div>
                        <h5 class="text-white mb-0">ADMIN</h5>
                        <small style="color: var(--brand-yellow);">TAP ME IN!</small>
                    </div>
                </div>
                
                <div class="mb-4 px-3">
                    <small class="text-uppercase" style="color: var(--brand-yellow); font-weight: 700; letter-spacing: 1px;">Main</small>
                </div>
                
                <a href="/admin" class="d-block p-3 mb-2 text-decoration-none rounded mx-2" style="color: white; transition: var(--transition);" onmouseover="this.style.background='rgba(255, 201, 20, 0.15)'; this.style.transform='translateX(4px)'" onmouseout="this.style.background=''; this.style.transform=''">
                    <i class="bi bi-speedometer2 me-2"></i>Overview
                </a>
                
                <a href="/admin/users" class="d-block p-3 mb-2 text-decoration-none rounded mx-2" style="color: white; transition: var(--transition);" onmouseover="this.style.background='rgba(255, 201, 20, 0.15)'; this.style.transform='translateX(4px)'" onmouseout="this.style.background=''; this.style.transform=''">
                    <i class="bi bi-people me-2"></i>Users
                </a>
                
                <a href="/admin/cards" class="d-block p-3 mb-2 text-decoration-none rounded mx-2" style="background: var(--brand-yellow); color: var(--brand-navy); font-weight: 600;">
                    <i class="bi bi-credit-card me-2"></i>Cards
                </a>
                
                <a href="/admin/analytics" class="d-block p-3 mb-2 text-decoration-none rounded mx-2" style="color: white; transition: var(--transition);" onmouseover="this.style.background='rgba(255, 201, 20, 0.15)'; this.style.transform='translateX(4px)'" onmouseout="this.style.background=''; this.style.transform=''">
                    <i class="bi bi-graph-up me-2"></i>Analytics
                </a>
                
                <div class="mb-4 mt-4 px-3">
                    <small class="text-uppercase" style="color: var(--brand-yellow); font-weight: 700; letter-spacing: 1px;">System</small>
                </div>
                
                <a href="/admin/support" class="d-block p-3 mb-2 text-decoration-none rounded mx-2" style="color: white; transition: var(--transition);" onmouseover="this.style.background='rgba(255, 201, 20, 0.15)'; this.style.transform='translateX(4px)'" onmouseout="this.style.background=''; this.style.transform=''">
                    <i class="bi bi-life-preserver me-2"></i>Support
                </a>
                
                <a href="/admin/settings" class="d-block p-3 mb-2 text-decoration-none rounded mx-2" style="color: white; transition: var(--transition);" onmouseover="this.style.background='rgba(255, 201, 20, 0.15)'; this.style.transform='translateX(4px)'" onmouseout="this.style.background=''; this.style.transform=''">
                    <i class="bi bi-gear me-2"></i>Settings
                </a>
                
                <div class="mb-4 mt-4 px-3">
                    <small class="text-uppercase" style="color: var(--brand-yellow); font-weight: 700; letter-spacing: 1px;">Quick</small>
                </div>
                
                <a href="/dashboard" class="d-block p-3 mb-2 text-decoration-none rounded mx-2" style="color: white; transition: var(--transition);" onmouseover="this.style.background='rgba(255, 201, 20, 0.15)'; this.style.transform='translateX(4px)'" onmouseout="this.style.background=''; this.style.transform=''">
                    <i class="bi bi-person-circle me-2"></i>User View
                </a>
                
                <a href="/auth/logout" class="d-block p-3 mb-2 text-decoration-none rounded mx-2" style="color: var(--brand-red); transition: var(--transition);" onmouseover="this.style.background='rgba(255, 89, 100, 0.15)'; this.style.transform='translateX(4px)'" onmouseout="this.style.background=''; this.style.transform=''">
                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                </a>
            </div>
        </nav>
        
        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="fade-in">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4">
                    <h1 class="display-4 fw-bold" style="color: var(--brand-navy);">
                        <i class="bi bi-credit-card me-2" style="color: var(--brand-yellow);"></i>
                        Cards Management
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-outline-secondary" onclick="exportCards()">
                                <i class="bi bi-download me-1"></i>Export
                            </button>
                        </div>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCardModal">
                            <i class="bi bi-plus me-1"></i>Create Cards
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form method="GET" action="/admin/cards" class="row g-3">
                            <div class="col-md-4">
                                <label for="search" class="form-label">Search Cards</label>
                                <div class="input-group">
                                    <span class="input-group-text" style="background: var(--brand-yellow-light); border-color: var(--border-color);">
                                        <i class="bi bi-search" style="color: var(--brand-navy);"></i>
                                    </span>
                                    <input type="text" class="form-control" id="search" name="search" value="{{filters.search}}" placeholder="Card ID, activation code, or nickname">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="">All Statuses</option>
                                    {{#each filters.statusOptions}}
                                        <option value="{{this}}" {{#if (eq this ../filters.status)}}selected{{/if}}>{{this}}</option>
                                    {{/each}}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="sortBy" class="form-label">Sort By</label>
                                <select class="form-select" id="sortBy" name="sortBy">
                                    <option value="createdAt" {{#if (eq filters.sortBy 'createdAt')}}selected{{/if}}>Created Date</option>
                                    <option value="cardUID" {{#if (eq filters.sortBy 'cardUID')}}selected{{/if}}>Card ID</option>
                                    <option value="status" {{#if (eq filters.sortBy 'status')}}selected{{/if}}>Status</option>
                                    <option value="tapCount" {{#if (eq filters.sortBy 'tapCount')}}selected{{/if}}>Tap Count</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="sortOrder" class="form-label">Order</label>
                                <select class="form-select" id="sortOrder" name="sortOrder">
                                    <option value="desc" {{#if (eq filters.sortOrder 'desc')}}selected{{/if}}>Newest First</option>
                                    <option value="asc" {{#if (eq filters.sortOrder 'asc')}}selected{{/if}}>Oldest First</option>
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="bi bi-funnel me-1"></i>Filter
                                </button>
                                <a href="/admin/cards" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Cards Table -->
                <div class="card">
                    <div class="card-header" style="background: var(--brand-navy); color: white;">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-credit-card me-2"></i>
                                Cards ({{pagination.totalCards}} total)
                            </h5>
                            <div class="d-flex align-items-center gap-2">
                                <select class="form-select form-select-sm" style="width: auto;" onchange="changeLimit(this.value)">
                                    <option value="20" {{#if (eq pagination.limit 20)}}selected{{/if}}>20 per page</option>
                                    <option value="50" {{#if (eq pagination.limit 50)}}selected{{/if}}>50 per page</option>
                                    <option value="100" {{#if (eq pagination.limit 100)}}selected{{/if}}>100 per page</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        {{#if cards.length}}
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead style="background: var(--bg-secondary);">
                                        <tr>
                                            <th>Card Details</th>
                                            <th>Owner</th>
                                            <th>Status</th>
                                            <th>Usage</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {{#each cards}}
                                            <tr style="transition: var(--transition);" onmouseover="this.style.background='var(--brand-yellow-light)'" onmouseout="this.style.background=''">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; border-radius: 8px; background: var(--brand-navy); color: white;">
                                                            <i class="bi bi-credit-card"></i>
                                                        </div>
                                                        <div>
                                                            <div class="fw-semibold" style="color: var(--brand-navy);">{{cardUID}}</div>
                                                            {{#if nickname}}
                                                                <small class="text-muted">{{nickname}}</small>
                                                            {{else}}
                                                                <small class="text-muted">No nickname</small>
                                                            {{/if}}
                                                            {{#if activationCode}}
                                                                <div><small class="badge bg-warning">{{activationCode}}</small></div>
                                                            {{/if}}
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    {{#if owner}}
                                                        <div>
                                                            <div class="fw-semibold">{{owner.firstName}} {{owner.lastName}}</div>
                                                            <small class="text-muted">{{owner.email}}</small>
                                                        </div>
                                                    {{else}}
                                                        <span class="text-muted">Unassigned</span>
                                                    {{/if}}
                                                </td>
                                                <td>
                                                    <span class="badge {{#if isActivated}}bg-success{{else if (eq status 'ready')}}bg-warning{{else}}bg-secondary{{/if}}">
                                                        {{#if isActivated}}Active{{else}}{{status}}{{/if}}
                                                    </span>
                                                    {{#if cardType}}
                                                        <div><small class="badge bg-info">{{cardType}}</small></div>
                                                    {{/if}}
                                                </td>
                                                <td>
                                                    <div class="fw-semibold" style="color: var(--brand-navy);">{{tapCount}} taps</div>
                                                    {{#if lastTapAt}}
                                                        <small class="text-muted">Last: {{formatDate lastTapAt}}</small>
                                                    {{else}}
                                                        <small class="text-muted">Never used</small>
                                                    {{/if}}
                                                </td>
                                                <td>
                                                    <div>{{formatDate createdAt}}</div>
                                                    {{#if batchNumber}}
                                                        <small class="text-muted">Batch: {{batchNumber}}</small>
                                                    {{/if}}
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary" onclick="viewCard('{{_id}}')" title="View Details">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                        <button class="btn btn-outline-secondary" onclick="editCard('{{_id}}')" title="Edit Card">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <form method="POST" action="/admin/cards/{{_id}}/toggle-status" style="display: inline;">
                                                            <button type="submit" class="btn btn-outline-{{#if isActivated}}warning{{else}}success{{/if}}" title="{{#if isActivated}}Deactivate{{else}}Activate{{/if}} Card">
                                                                <i class="bi bi-{{#if isActivated}}pause{{else}}play{{/if}}"></i>
                                                            </button>
                                                        </form>
                                                        <button class="btn btn-outline-danger" onclick="deleteCard('{{_id}}')" title="Delete Card">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        {{/each}}
                                    </tbody>
                                </table>
                            </div>
                        {{else}}
                            <div class="text-center py-5">
                                <div class="d-flex align-items-center justify-content-center rounded mb-3 mx-auto" style="width: 80px; height: 80px; background: rgba(52, 89, 149, 0.1); color: var(--brand-navy);">
                                    <i class="bi bi-credit-card fs-1"></i>
                                </div>
                                <h5 style="color: var(--brand-navy);">No Cards Found</h5>
                                <p class="text-muted">No cards match your current filters.</p>
                                <a href="/admin/cards" class="btn btn-outline-secondary">Clear Filters</a>
                            </div>
                        {{/if}}
                    </div>

                    <!-- Pagination -->
                    {{#if pagination.totalPages}}
                        <div class="card-footer" style="background: var(--bg-secondary);">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    Showing {{#if cards.length}}{{math (math pagination.currentPage minus 1) times 20 plus 1}} - {{math pagination.currentPage times 20}}{{else}}0{{/if}} of {{pagination.totalCards}} cards
                                </small>
                                
                                {{#if (gt pagination.totalPages 1)}}
                                    <nav aria-label="Cards pagination">
                                        <ul class="pagination pagination-sm mb-0">
                                            {{#if pagination.hasPrev}}
                                                <li class="page-item">
                                                    <a class="page-link" href="?page={{pagination.prevPage}}&{{buildQueryString filters}}">
                                                        <i class="bi bi-chevron-left"></i>
                                                    </a>
                                                </li>
                                            {{/if}}
                                            
                                            {{#times pagination.totalPages}}
                                                {{#if (eq this ../pagination.currentPage)}}
                                                    <li class="page-item active">
                                                        <span class="page-link">{{this}}</span>
                                                    </li>
                                                {{else if (or (eq this 1) (eq this ../pagination.totalPages) (and (gte this (math ../pagination.currentPage minus 2)) (lte this (math ../pagination.currentPage plus 2))))}}
                                                    <li class="page-item">
                                                        <a class="page-link" href="?page={{this}}&{{buildQueryString ../filters}}">{{this}}</a>
                                                    </li>
                                                {{else if (eq this 2)}}
                                                    <li class="page-item disabled">
                                                        <span class="page-link">...</span>
                                                    </li>
                                                {{/if}}
                                            {{/times}}
                                            
                                            {{#if pagination.hasNext}}
                                                <li class="page-item">
                                                    <a class="page-link" href="?page={{pagination.nextPage}}&{{buildQueryString filters}}">
                                                        <i class="bi bi-chevron-right"></i>
                                                    </a>
                                                </li>
                                            {{/if}}
                                        </ul>
                                    </nav>
                                {{/if}}
                            </div>
                        </div>
                    {{/if}}
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Create Card Batch Modal -->
<div class="modal fade" id="createCardModal" tabindex="-1" aria-labelledby="createCardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--brand-navy); color: white;">
                <h5 class="modal-title" id="createCardModalLabel">
                    <i class="bi bi-credit-card me-2"></i>Create Card Batch
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createCardForm" action="/admin/create-cards" method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="batchSize" class="form-label">Number of Cards</label>
                            <input type="number" class="form-control" id="batchSize" name="batchSize" min="1" max="1000" value="10" required>
                            <div class="form-text">Maximum 1000 cards per batch</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cardType" class="form-label">Card Type</label>
                            <select class="form-select" id="cardType" name="cardType" required>
                                <option value="nfc">NFC Card</option>
                                <option value="qr">QR Code</option>
                                <option value="hybrid">Hybrid (NFC + QR)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="batchNumber" class="form-label">Batch Number</label>
                        <input type="text" class="form-control" id="batchNumber" name="batchNumber" placeholder="e.g., BATCH001" required>
                        <div class="form-text">Unique identifier for this batch</div>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Manufacturing notes, client information, etc."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus me-1"></i>Create Cards
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Card management functions
function viewCard(cardId) {
    // For now, just show an alert. In production, this would open a detailed view
    alert('View card details for: ' + cardId);
}

function editCard(cardId) {
    // For now, just show an alert. In production, this would open an edit modal
    alert('Edit card: ' + cardId);
}

function deleteCard(cardId) {
    if (confirm('Are you sure you want to delete this card? This action cannot be undone.')) {
        fetch(`/admin/cards/${cardId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting card: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error deleting card: ' + error.message);
        });
    }
}

function exportCards() {
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'csv');
    window.location.href = '/admin/cards?' + params.toString();
}

function changeLimit(limit) {
    const params = new URLSearchParams(window.location.search);
    params.set('limit', limit);
    params.set('page', '1'); // Reset to first page
    window.location.href = '/admin/cards?' + params.toString();
}

// Form submission handling
document.getElementById('createCardForm').addEventListener('submit', function(e) {
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="bi bi-arrow-clockwise bi-spin me-1"></i>Creating...';
    submitBtn.disabled = true;
    
    // Re-enable after timeout if not redirected
    setTimeout(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 10000);
});

// Auto-generate batch number
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const batchNumber = `BATCH${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
    document.getElementById('batchNumber').value = batchNumber;
});
</script>